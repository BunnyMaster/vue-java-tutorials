## 脚本示例

> [!NOTE]  
> 初始化登录的账号和密码：
> 
> 账号：root  
> 密码：Dev1234!

创建 `docker-compose.yaml` 文件，之后使用 `docker compose up -d` 进行启动。

- `external_url` 要改成你的服务地址  
- `initial_root_password` 是设置的密码  

需要修改的内容：

1. `external_url`  
2. `volumes` 路径——如果不想和我一样  
3. `shm_size`——如果不想和我一样  
4. `restart`——如果不想和我一样  

```yaml
# 定义整个开发栈的名称
name: microservices-dev-stack

services:
  # ==================== GitLab ====================
  gitlab:
    container_name: gitlab
    image: gitlab/gitlab-ce:latest
    hostname: 'gitlab.local'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://192.168.3.19:8929'
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
        gitlab_rails['time_zone'] = 'Asia/Shanghai'
        gitlab_rails['gitlab_email_enabled'] = true
        gitlab_rails['gitlab_email_from'] = 'gitlab@local.dev'
        gitlab_rails['smtp_enable'] = false
        gitlab_rails['gitlab_default_can_create_group'] = true
        gitlab_rails['gitlab_username_changing_enabled'] = true
        gitlab_rails['initial_root_password'] = 'Dev1234!'
        gitlab_rails['initial_shared_runners_registration_token'] = 'GR1348941'
        gitlab_rails['gitlab_default_projects_features_issues'] = true
        gitlab_rails['gitlab_default_projects_features_merge_requests'] = true
        gitlab_rails['gitlab_default_projects_features_wiki'] = true
        gitlab_rails['gitlab_default_projects_features_snippets'] = true
        gitlab_rails['gitlab_default_projects_features_builds'] = true
    ports:
      - "8929:8929"   # HTTP端口
      - "2224:22"     # SSH端口
      - "8443:443"     # HTTPS端口
    volumes:
      - ~/docker-compose/develop/gitlab/config:/etc/gitlab
      - ~/docker-compose/develop/gitlab/logs:/var/log/gitlab
      - ~/docker-compose/develop/gitlab/data:/var/opt/gitlab
    networks:
      - microservices-net
    restart: unless-stopped
    shm_size: '256m'

  # ==================== GitLab Runner ====================
  gitlab-runner:
    container_name: gitlab-runner
    image: gitlab/gitlab-runner:latest
    volumes:
      - ~/docker-compose/develop/gitlab-runner/config:/etc/gitlab-runner
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    networks:
      - microservices-net
    restart: unless-stopped
    depends_on:
      - gitlab

  # ==================== Jenkins (可选，作为CI/CD的替代方案) ====================
  jenkins:
    container_name: jenkins
    image: jenkins/jenkins:lts-jdk17
    ports:
      - "8080:8080"
      - "50000:50000"
    environment:
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false
      - JENKINS_ADMIN_ID=admin
      - JENKINS_ADMIN_PASSWORD=Dev1234!
    volumes:
      - ~/docker-compose/develop/jenkins/data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/docker-compose/develop/jenkins/jobs:/var/jenkins_home/jobs
    networks:
      - microservices-net
    restart: unless-stopped
    user: root

networks:
  microservices-net:
    name: microservices-dev-network
    driver: bridge
```

GitLab 第一次启动需要较长时间（5–10分钟）进行初始化配置。  
可以通过以下命令查看启动状态：

```bash
docker logs -f gitlab
```

当看到以下日志时表示启动完成：

```bash
gitlab Reconfigured!
```

正常脚本正确搭建一般不会有太多问题，毕竟是开源知名项目。有问题一般是配置问题，比如访问地址（`external_url`）、端口号等。

## 安装GitLab

### 登录密码

> [!TIP]  
> 如果使用的是**环境搭建**的脚本，密码就是指定的 `Dev1234!`。

GitLab 没有在配置文件配置密码，那么需要按照下面方式获取：

#### 日志查看

如果 Docker 启动成功，可以在日志中查看到密码：

```bash
docker logs gitlab
```

### 进入容器查看

> [!IMPORTANT]  
> 这种方式获取的密码会在24小时后删除。

```bash
# 进入容器
docker exec -it gitlab /bin/bash

# 查看初始密码文件
cat /etc/gitlab/initial_root_password
```

### 修改访问地址

如果使用 `docker-compose` 安装，可以在配置文件中修改；如果没有用 Docker 方式，需要手动修改。

#### Docker 修改

在 `docker-compose.yaml` 中修改 `external_url`：

```
external_url 'http://192.168.3.19:8929'
```

#### 手动修改方式

使用 `vim /etc/gitlab/gitlab.rb` 修改配置文件，修改 `external_url` 地址即可：

```bash
##! Note: During installation/upgrades, the value of the environment variable
##! EXTERNAL_URL will be used to populate/replace this value.
##! On AWS EC2 instances, we also attempt to fetch the public hostname/IP
##! address from AWS. For more details, see:
##! https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html
# external_url 'GENERATED_EXTERNAL_URL'
```