# Spring Boot 3.x 条件注解完全指南

## 一、条件注解分类总览

| 类别      | 数量 | 主要注解                                                     | 作用场景       |
| --------- | ---- | ------------------------------------------------------------ | -------------- |
| Class相关 | 3个  | @ConditionalOnClass<br>@ConditionalOnMissingClass<br>@ConditionalOnJava | 类路径依赖检查 |
| Bean相关  | 4个  | @ConditionalOnBean<br>@ConditionalOnMissingBean<br>@ConditionalOnSingleCandidate | Bean存在性检查 |
| 配置相关  | 3个  | @ConditionalOnProperty<br>@ConditionalOnExpression<br>@ConditionalOnResource | 配置和资源检查 |
| Web相关   | 3个  | @ConditionalOnWebApplication<br>@ConditionalOnNotWebApplication<br>@ConditionalOnWarDeployment | Web环境检测    |
| 环境相关  | 2个  | @ConditionalOnCloudPlatform<br>@Profile                      | 运行环境检测   |
| 自定义    | 1个  | @Conditional                                                 | 自定义条件逻辑 |

## 二、详细用法表格

### 1. Class相关条件注解

| 注解                           | 参数           | 默认值 | 示例                                                         | 作用               |
| ------------------------------ | -------------- | ------ | ------------------------------------------------------------ | ------------------ |
| **@ConditionalOnClass**        | value<br>name  | -      | `@ConditionalOnClass(DataSource.class)`<br>`@ConditionalOnClass(name="javax.sql.DataSource")` | 类存在时生效       |
| **@ConditionalOnMissingClass** | value<br>name  | -      | `@ConditionalOnMissingClass("com.old.Legacy")`               | 类不存在时生效     |
| **@ConditionalOnJava**         | value<br>range | -      | `@ConditionalOnJava(JavaVersion.SEVENTEEN)`                  | Java版本匹配时生效 |

### 2. Bean相关条件注解

| 注解                              | 参数                             | 常用值 | 示例                                                         | 作用               |
| --------------------------------- | -------------------------------- | ------ | ------------------------------------------------------------ | ------------------ |
| **@ConditionalOnBean**            | value<br>type<br>name<br>search  | -      | `@ConditionalOnBean(DataSource.class)`<br>`@ConditionalOnBean(name="myDataSource")` | Bean存在时生效     |
| **@ConditionalOnMissingBean**     | value<br>type<br>name<br>ignored | -      | `@ConditionalOnMissingBean`<br>`@ConditionalOnMissingBean(MyService.class)` | Bean不存在时生效   |
| **@ConditionalOnSingleCandidate** | value<br>type                    | -      | `@ConditionalOnSingleCandidate(DataSource.class)`            | 唯一候选Bean时生效 |

### 3. 配置相关条件注解

| 注解                         | 参数                                            | 说明                                        | 示例                                                         | 作用               |
| ---------------------------- | ----------------------------------------------- | ------------------------------------------- | ------------------------------------------------------------ | ------------------ |
| **@ConditionalOnProperty**   | prefix<br>name<br>havingValue<br>matchIfMissing | prefix:配置前缀<br>matchIfMissing:默认false | `@ConditionalOnProperty(prefix="app", name="enabled", havingValue="true")` | 配置匹配时生效     |
| **@ConditionalOnExpression** | value                                           | SpEL表达式                                  | `@ConditionalOnExpression("${app.feature.enabled:false}")`   | 表达式为true时生效 |
| **@ConditionalOnResource**   | resources                                       | 资源路径                                    | `@ConditionalOnResource("classpath:config/")`                | 资源存在时生效     |

### 4. Web相关条件注解

| 注解                                | 参数 | 类型             | 示例                                              | 作用            |
| ----------------------------------- | ---- | ---------------- | ------------------------------------------------- | --------------- |
| **@ConditionalOnWebApplication**    | type | SERVLET/REACTIVE | `@ConditionalOnWebApplication(type=Type.SERVLET)` | Web应用时生效   |
| **@ConditionalOnNotWebApplication** | -    | -                | `@ConditionalOnNotWebApplication`                 | 非Web应用时生效 |
| **@ConditionalOnWarDeployment**     | -    | -                | `@ConditionalOnWarDeployment`                     | WAR部署时生效   |

### 5. 环境相关条件注解

| 注解                            | 参数  | 支持平台                              | 示例                                                    | 作用            |
| ------------------------------- | ----- | ------------------------------------- | ------------------------------------------------------- | --------------- |
| **@ConditionalOnCloudPlatform** | value | KUBERNETES<br>CLOUD_FOUNDRY<br>HEROKU | `@ConditionalOnCloudPlatform(CloudPlatform.KUBERNETES)` | 特定云平台生效  |
| **@Profile**                    | value | 环境名称                              | `@Profile("dev")`<br>`@Profile({"dev", "test"})`        | 指定Profile生效 |

### 6. 新增条件注解（Spring Boot 3.x）

| 注解                                   | Spring Boot版本 | 参数      | 示例                                         | 作用               |
| -------------------------------------- | --------------- | --------- | -------------------------------------------- | ------------------ |
| **@ConditionalOnThreading**            | 3.2+            | Threading | `@ConditionalOnThreading(Threading.VIRTUAL)` | 虚拟线程支持       |
| **@ConditionalOnInitializedRestarter** | 3.x+            | -         | `@ConditionalOnInitializedRestarter`         | DevTools重启器生效 |

## 三、条件注解组合使用

### 组合使用场景表

| 场景                | 推荐组合                   | 示例                                                         |
| ------------------- | -------------------------- | ------------------------------------------------------------ |
| **Web服务默认配置** | Web + Class + Property     | `@ConditionalOnWebApplication`<br>`@ConditionalOnClass(Servlet.class)`<br>`@ConditionalOnProperty("app.web.enabled")` |
| **数据源自动配置**  | Class + Bean + Property    | `@ConditionalOnClass(DataSource.class)`<br>`@ConditionalOnMissingBean(DataSource.class)`<br>`@ConditionalOnProperty("spring.datasource.url")` |
| **缓存配置**        | Class + Profile + Property | `@ConditionalOnClass(RedisConnectionFactory.class)`<br>`@Profile("prod")`<br>`@ConditionalOnProperty("cache.type")` |
| **安全配置**        | Web + Expression           | `@ConditionalOnWebApplication`<br>`@ConditionalOnExpression("${app.security.enabled:true}")` |

## 四、执行优先级和顺序

### 条件注解执行顺序表

| 优先级 | 条件注解                                           | 执行时机       | 说明                          |
| ------ | -------------------------------------------------- | -------------- | ----------------------------- |
| 1      | @ConditionalOnClass<br>@ConditionalOnMissingClass  | 最早执行       | 检查类路径，避免ClassNotFound |
| 2      | @ConditionalOnBean<br>@ConditionalOnMissingBean    | Bean解析阶段   | 需要BeanDefinition已加载      |
| 3      | @ConditionalOnProperty<br>@ConditionalOnExpression | 配置解析后     | 需要Environment已就绪         |
| 4      | @ConditionalOnResource                             | 资源检查阶段   |                               |
| 5      | @ConditionalOnWebApplication                       | 应用类型确定后 |                               |
| 6      | 自定义@Conditional                                 | 最后执行       |                               |

## 五、常见问题解决方案表

| 问题               | 现象            | 解决方案                   | 代码示例                                           |
| ------------------ | --------------- | -------------------------- | -------------------------------------------------- |
| **条件不生效**     | Bean被意外创建  | 将条件移到类级别           | `@Configuration`<br>`@ConditionalOnClass(X.class)` |
| **循环依赖**       | 启动失败        | 重新设计或使用@DependsOn   | 避免A依赖B，B依赖A                                 |
| **条件冲突**       | 多个Bean冲突    | 使用name或type精确指定     | `@ConditionalOnBean(name="specificBean")`          |
| **Profile不生效**  | Profile配置无效 | 检查spring.profiles.active | 确保Profile已激活                                  |
| **SpEL表达式错误** | 启动异常        | 使用默认值                 | `@ConditionalOnExpression("${prop:false}")`        |

## 六、最佳实践配置示例

### 1. 自动配置类模板

```java
@AutoConfiguration(after = DataSourceAutoConfiguration.class)
@ConditionalOnClass({DataSource.class, JdbcTemplate.class})
@ConditionalOnBean(DataSource.class)
@ConditionalOnProperty(
    prefix = "app.db",
    name = "auto-configure",
    havingValue = "true",
    matchIfMissing = true
)
public class JdbcAutoConfiguration {
    
    @Bean
    @ConditionalOnMissingBean  // 允许用户覆盖
    public JdbcTemplate jdbcTemplate(DataSource dataSource) {
        return new JdbcTemplate(dataSource);
    }
}
```

### 2. 条件注解选择决策表

| 需求场景     | 首选注解                    | 备选方案                   | 理由              |
| ------------ | --------------------------- | -------------------------- | ----------------- |
| 提供默认实现 | @ConditionalOnMissingBean   | -                          | 允许用户覆盖      |
| 功能开关     | @ConditionalOnProperty      | @ConditionalOnExpression   | 配置驱动          |
| 环境适配     | @Profile                    | @ConditionalOnProperty     | 环境隔离          |
| 依赖检查     | @ConditionalOnClass         | @ConditionalOnMissingClass | 避免ClassNotFound |
| 云原生       | @ConditionalOnCloudPlatform | -                          | 云平台适配        |

### 3. Spring Boot 3.x 新特性表

| 特性               | 条件注解支持                              | 说明         |
| ------------------ | ----------------------------------------- | ------------ |
| **虚拟线程**       | @ConditionalOnThreading                   | Java 21+     |
| **GraalVM原生**    | 自动适配                                  | 需要额外配置 |
| **JDK 17+特性**    | @ConditionalOnJava(JavaVersion.SEVENTEEN) | 版本检测     |
| **配置属性Record** | 所有条件注解兼容                          | Record类支持 |

## 七、配置覆盖优先级表

| 优先级 | 覆盖方式        | 条件注解配合                  | 示例                     |
| ------ | --------------- | ----------------------------- | ------------------------ |
| 最高   | 用户自定义Bean  | @ConditionalOnMissingBean     | 用户定义后自动配置不生效 |
| 高     | @Primary注解    | @ConditionalOnSingleCandidate | 标记为首选Bean           |
| 中     | Profile特定配置 | @Profile                      | dev/prod环境不同配置     |
| 低     | 配置属性        | @ConditionalOnProperty        | application.yml中配置    |
| 最低   | 默认配置        | 所有条件注解                  | 自动配置的默认值         |

## 八、完整示例：多环境数据源配置

```java
@Configuration
public class DataSourceConfig {
    
    // 开发环境 - H2
    @Bean
    @Profile("dev")
    @ConditionalOnProperty(name = "spring.datasource.url", matchIfMissing = true)
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource devDataSource() {
        return new EmbeddedDatabaseBuilder()
            .setType(EmbeddedDatabaseType.H2)
            .build();
    }
    
    // 生产环境 - MySQL
    @Bean
    @Profile("prod")
    @ConditionalOnClass(com.mysql.cj.jdbc.Driver.class)
    @ConditionalOnProperty("spring.datasource.url")
    @ConditionalOnMissingBean(DataSource.class)
    public DataSource prodDataSource(
            @Value("${spring.datasource.url}") String url,
            @Value("${spring.datasource.username}") String username,
            @Value("${spring.datasource.password}") String password) {
        return DataSourceBuilder.create()
            .url(url)
            .username(username)
            .password(password)
            .build();
    }
    
    // 测试环境 - 根据配置选择
    @Bean
    @Profile("test")
    @ConditionalOnExpression("#{environment.acceptsProfiles('test') && " +
                            "environment.containsProperty('test.db.type')}")
    public DataSource testDataSource(Environment env) {
        String type = env.getProperty("test.db.type", "h2");
        // 根据类型创建不同的数据源
    }
}
```

## 总结要点

1. **Spring Boot 3.x** 条件注解**约20+个**，分为6大类
2. **最常用**的是：`@ConditionalOnMissingBean`、`@ConditionalOnProperty`、`@ConditionalOnClass`
3. **执行顺序**：Class检查 → Bean检查 → 配置检查 → 环境检查
4. **最佳实践**：类级别条件 + 方法级别条件 + `@ConditionalOnMissingBean`
5. **Spring Boot 3.x** 新增虚拟线程和云平台支持

这样的表格形式可以帮助你快速查找和选择合适的条件注解，提高开发效率。