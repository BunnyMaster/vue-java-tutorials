# Redisç¼“å­˜é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“Œ ç¼“å­˜ç©¿é€

### ä»€ä¹ˆæ˜¯ç¼“å­˜ç©¿é€ï¼Ÿ
**ç¼“å­˜ç©¿é€**æ˜¯æŒ‡æŸ¥è¯¢ä¸€ä¸ª**ä¸å­˜åœ¨çš„æ•°æ®**ï¼Œè¯¥æ•°æ®åœ¨ç¼“å­˜å’Œæ•°æ®åº“ä¸­éƒ½ä¸å­˜åœ¨ã€‚å¯¼è‡´æ¯æ¬¡è¯·æ±‚éƒ½ä¼šç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œå¯èƒ½å¼•å‘æ•°æ®åº“å‹åŠ›è¿‡å¤§ç”šè‡³å®•æœºã€‚

### æ ¹æœ¬åŸå› 
- **æ¶æ„æ”»å‡»**ï¼šæ”»å‡»è€…æ•…æ„æŸ¥è¯¢å¤§é‡ä¸å­˜åœ¨çš„key
- **ä¸šåŠ¡å¼‚å¸¸**ï¼šä¸šåŠ¡é€»è¾‘é”™è¯¯äº§ç”Ÿå¤§é‡æ— æ•ˆæŸ¥è¯¢

### æ­£å¸¸æŸ¥è¯¢æµç¨‹
å…ˆæŸ¥è¯¢ç¼“å­˜ï¼Œè‹¥ä¸å­˜åœ¨åˆ™æŸ¥è¯¢æ•°æ®åº“ï¼Œå°†ç»“æœå­˜å…¥ç¼“å­˜åè¿”å›ã€‚

```java
public HotelVO queryById(Long id) {
    String redisKey = CACHE_HOTEL_KEY + id;
    Object hotelObject = redisTemplate.opsForValue().get(redisKey);

    if (hotelObject != null) {
        return JSONUtil.toBean(JSON.toJSONString(hotelObject), HotelVO.class);
    }

    HotelEntity hotel = super.getById(id);
    if (hotel == null) {
        throw new RuntimeException("é…’åº—ä¸å­˜åœ¨");
    }

    HotelVO hotelVO = BeanUtil.copyProperties(hotel, HotelVO.class);
    hotelVO.setSystemTime(LocalDateTime.now());
    redisTemplate.opsForValue().set(redisKey, hotelVO, 30, TimeUnit.SECONDS);
    return hotelVO;
}
```

### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

#### 1. ç¼“å­˜ç©ºå¯¹è±¡
å½“æŸ¥è¯¢åˆ°æ•°æ®ä¸å­˜åœ¨æ—¶ï¼Œå°†ç©ºå€¼ï¼ˆå¦‚"NULL"ï¼‰å­˜å…¥ç¼“å­˜å¹¶è®¾ç½®è¾ƒçŸ­è¿‡æœŸæ—¶é—´ã€‚

```java
public HotelVO queryById(Long id) {
    String redisKey = CACHE_HOTEL_KEY + id;
    
    // æŸ¥è¯¢ç¼“å­˜
    String cacheValue = (String) redisTemplate.opsForValue().get(redisKey);
    
    if (cacheValue != null) {
        if (NULL_VALUE.equals(cacheValue)) {
            throw new RuntimeException("é…’åº—ä¸å­˜åœ¨");
        }
        return JSON.parseObject(cacheValue, HotelVO.class);
    }
    
    // æŸ¥è¯¢æ•°æ®åº“
    HotelEntity hotel = super.getById(id);
    if (hotel == null) {
        // ç¼“å­˜ç©ºå€¼ï¼Œè®¾ç½®è¾ƒçŸ­è¿‡æœŸæ—¶é—´
        redisTemplate.opsForValue().set(redisKey, NULL_VALUE, 5, TimeUnit.MINUTES);
        throw new RuntimeException("é…’åº—ä¸å­˜åœ¨");
    }
    
    HotelVO hotelVO = BeanUtil.copyProperties(hotel, HotelVO.class);
    redisTemplate.opsForValue().set(redisKey, JSON.toJSONString(hotelVO), 30, TimeUnit.MINUTES);
    return hotelVO;
}
```

#### 2. å¸ƒéš†è¿‡æ»¤å™¨
ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨é¢„å…ˆåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œé¿å…æŸ¥è¯¢æ•°æ®åº“ã€‚

```java
@Component
public class BloomFilterService {
    
    private final BloomFilter<Long> bloomFilter;
    
    public BloomFilterService() {
        // é¢„è®¡å…ƒç´ æ•°é‡100ä¸‡ï¼Œè¯¯åˆ¤ç‡1%
        this.bloomFilter = BloomFilter.create(
            Funnels.longFunnel(), 
            1000000, 
            0.01
        );
    }
    
    // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨
    public void initBloomFilter(List<Long> existingIds) {
        for (Long id : existingIds) {
            bloomFilter.put(id);
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦å­˜åœ¨
    public boolean mightContain(Long id) {
        return bloomFilter.mightContain(id);
    }
}

// åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨
public HotelVO queryByIdWithBloomFilter(Long id) {
    // å…ˆç”¨å¸ƒéš†è¿‡æ»¤å™¨åˆ¤æ–­
    if (!bloomFilterService.mightContain(id)) {
        throw new RuntimeException("é…’åº—ä¸å­˜åœ¨");
    }
    
    // åç»­é€»è¾‘ä¸ä¹‹å‰ç›¸åŒ
    return queryById(id);
}
```

#### æ–¹æ¡ˆå¯¹æ¯”è¡¨
| æ–¹æ¡ˆ           | ä¼˜ç‚¹               | ç¼ºç‚¹                 | é€‚ç”¨åœºæ™¯                 |
| -------------- | ------------------ | -------------------- | ------------------------ |
| **ç¼“å­˜ç©ºå¯¹è±¡** | å®ç°ç®€å•ã€ç»´æŠ¤æ–¹ä¾¿ | å†…å­˜æ¶ˆè€—ã€æ•°æ®ä¸ä¸€è‡´ | æ•°æ®ç›¸å¯¹å›ºå®šã€ç©ºæŸ¥è¯¢ä¸å¤š |
| **å¸ƒéš†è¿‡æ»¤å™¨** | å†…å­˜å ç”¨å°‘ã€æ€§èƒ½é«˜ | å®ç°å¤æ‚ã€æœ‰è¯¯åˆ¤ç‡   | æµ·é‡æ•°æ®ã€é˜²æ­¢æ¶æ„æ”»å‡»   |

## â„ï¸ ç¼“å­˜é›ªå´©

### ä»€ä¹ˆæ˜¯ç¼“å­˜é›ªå´©ï¼Ÿ
**ç¼“å­˜é›ªå´©**æ˜¯æŒ‡åœ¨åŒä¸€æ—¶æ®µå¤§é‡çš„ç¼“å­˜keyåŒæ—¶å¤±æ•ˆæˆ–è€…RedisæœåŠ¡å®•æœºï¼Œå¯¼è‡´å¤§é‡è¯·æ±‚ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œé€ æˆæ•°æ®åº“å·¨å¤§å‹åŠ›ã€‚

### è§£å†³æ–¹æ¡ˆ
- **å·®å¼‚åŒ–è¿‡æœŸæ—¶é—´**ï¼šç»™ä¸åŒçš„Keyçš„TTLæ·»åŠ éšæœºå€¼
- **é«˜å¯ç”¨æ¶æ„**ï¼šåˆ©ç”¨Redisé›†ç¾¤æé«˜æœåŠ¡çš„å¯ç”¨æ€§
- **é™çº§é™æµ**ï¼šç»™ç¼“å­˜ä¸šåŠ¡æ·»åŠ é™çº§é™æµç­–ç•¥
- **å¤šçº§ç¼“å­˜**ï¼šç»™ä¸šåŠ¡æ·»åŠ å¤šçº§ç¼“å­˜ï¼ˆå¦‚æœ¬åœ°ç¼“å­˜+Redisï¼‰

## âš¡ ç¼“å­˜å‡»ç©¿

### ä»€ä¹ˆæ˜¯ç¼“å­˜å‡»ç©¿ï¼Ÿ
**ç¼“å­˜å‡»ç©¿**ï¼ˆçƒ­ç‚¹Keyé—®é¢˜ï¼‰æ˜¯æŒ‡ä¸€ä¸ªè¢«é«˜å¹¶å‘è®¿é—®å¹¶ä¸”ç¼“å­˜é‡å»ºä¸šåŠ¡è¾ƒå¤æ‚çš„keyçªç„¶å¤±æ•ˆï¼Œå¤§é‡è¯·æ±‚åœ¨ç¬é—´ç»™æ•°æ®åº“å¸¦æ¥å·¨å¤§å†²å‡»ã€‚

### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

#### 1. äº’æ–¥é”
ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹å»é‡å»ºç¼“å­˜ã€‚

**ä¼˜ç‚¹**ï¼š
- æ²¡æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—
- ä¿è¯æ•°æ®ä¸€è‡´æ€§
- å®ç°ç›¸å¯¹ç®€å•

**ç¼ºç‚¹**ï¼š
- çº¿ç¨‹éœ€è¦ç­‰å¾…ï¼Œæ€§èƒ½å—å½±å“
- å¯èƒ½æœ‰æ­»é”é£é™©

#### 2. é€»è¾‘è¿‡æœŸ
ä¸è®¾ç½®å®é™…è¿‡æœŸæ—¶é—´ï¼Œè€Œæ˜¯åœ¨valueä¸­å­˜å‚¨é€»è¾‘è¿‡æœŸæ—¶é—´ã€‚

**ä¼˜ç‚¹**ï¼š
- çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œæ€§èƒ½è¾ƒå¥½

**ç¼ºç‚¹**ï¼š
- ä¸ä¿è¯å¼ºä¸€è‡´æ€§
- æœ‰é¢å¤–å†…å­˜æ¶ˆè€—
- å®ç°ç›¸å¯¹å¤æ‚

### é€‰æ‹©ä¾æ®
æ ¹æ®ä¸šåŠ¡éœ€æ±‚åœ¨**ä¸€è‡´æ€§**å’Œ**å¯ç”¨æ€§**ä¹‹é—´æƒè¡¡ï¼š
- å¼ºä¸€è‡´æ€§åœºæ™¯ â†’ é€‰æ‹©äº’æ–¥é”
- é«˜å¯ç”¨æ€§åœºæ™¯ â†’ é€‰æ‹©é€»è¾‘è¿‡æœŸ

## ğŸ› ï¸ ç»¼åˆè§£å†³æ–¹æ¡ˆæµç¨‹

### æµç¨‹è¯´æ˜

#### 1. ç¼“å­˜æŸ¥è¯¢é˜¶æ®µ
- **æ­¥éª¤1**ï¼šæ ¹æ®é…’åº—IDç”ŸæˆRedisç¼“å­˜é”®å’Œåˆ†å¸ƒå¼é”é”®
- **æ­¥éª¤2**ï¼šé¦–å…ˆæŸ¥è¯¢Redisç¼“å­˜
  - å¦‚æœç¼“å­˜å‘½ä¸­ä¸”ä¸ºæœ‰æ•ˆæ•°æ® â†’ ç›´æ¥è¿”å›é…’åº—ä¿¡æ¯
  - å¦‚æœç¼“å­˜å‘½ä¸­ä¸”ä¸ºç©ºå€¼æ ‡è®° â†’ è¿”å›nullï¼ˆé˜²æ­¢ç¼“å­˜ç©¿é€ï¼‰
  - å¦‚æœç¼“å­˜æœªå‘½ä¸­ â†’ è¿›å…¥ç¼“å­˜é‡å»ºæµç¨‹

#### 2. åˆ†å¸ƒå¼é”è·å–é˜¶æ®µ
- **æ­¥éª¤3**ï¼šå°è¯•è·å–åˆ†å¸ƒå¼é”ï¼Œæœ€å¤šé‡è¯•3æ¬¡
  - æ¯æ¬¡é‡è¯•é—´éš”50ms
  - å¦‚æœ3æ¬¡éƒ½å¤±è´¥ â†’ ç›´æ¥è¿”å›nullï¼ˆé¿å…ç­‰å¾…ï¼‰
  - æˆåŠŸè·å–é” â†’ è¿›å…¥ç¼“å­˜é‡å»º

#### 3. ç¼“å­˜é‡å»ºé˜¶æ®µ
- **æ­¥éª¤4**ï¼šåŒé‡æ£€æŸ¥ç¼“å­˜ï¼ˆé˜²æ­¢é‡å¤é‡å»ºï¼‰
- **æ­¥éª¤5**ï¼šæŸ¥è¯¢æ•°æ®åº“
  - å¦‚æœæ•°æ®åº“ä¸å­˜åœ¨è¯¥æ•°æ® â†’ ç¼“å­˜ç©ºå€¼ï¼ˆ5åˆ†é’Ÿè¿‡æœŸï¼‰â†’ è¿”å›null
  - å¦‚æœæ•°æ®åº“å­˜åœ¨æ•°æ® â†’ æ„å»ºVOå¯¹è±¡ â†’ å†™å…¥ç¼“å­˜ï¼ˆ30åˆ†é’Ÿè¿‡æœŸï¼‰â†’ è¿”å›æ•°æ®

#### 4. æ¸…ç†é˜¶æ®µ
- **æ­¥éª¤6**ï¼šæ— è®ºæˆåŠŸä¸å¦ï¼Œæœ€ç»ˆé‡Šæ”¾åˆ†å¸ƒå¼é”

### æµç¨‹å›¾
```mermaid
graph TD
    A[å¼€å§‹æŸ¥è¯¢é…’åº—] --> B[ç”ŸæˆRedisé”®å’Œé”é”®]
    B --> C[æŸ¥è¯¢Redisç¼“å­˜]
    
    C --> D{ç¼“å­˜æ˜¯å¦å­˜åœ¨?}
    D -->|å­˜åœ¨| E{æ˜¯ç©ºå€¼æ ‡è®°?}
    E -->|æ˜¯| F[è¿”å›null]
    E -->|å¦| G[è§£æç¼“å­˜æ•°æ®å¹¶è¿”å›]
    
    D -->|ä¸å­˜åœ¨| H[å°è¯•è·å–åˆ†å¸ƒå¼é”]
    H --> I{è·å–æˆåŠŸ?}
    I -->|å¤±è´¥| J[è¿”å›null]
    
    I -->|æˆåŠŸ| K[åŒé‡æ£€æŸ¥ç¼“å­˜]
    K --> L{ç¼“å­˜æ˜¯å¦å­˜åœ¨?}
    L -->|å­˜åœ¨| M[é‡Šæ”¾é”å¹¶è¿”å›æ•°æ®]
    
    L -->|ä¸å­˜åœ¨| N[æŸ¥è¯¢æ•°æ®åº“]
    N --> O{æ•°æ®æ˜¯å¦å­˜åœ¨?}
    O -->|ä¸å­˜åœ¨| P[ç¼“å­˜ç©ºå€¼5åˆ†é’Ÿ]
    P --> Q[é‡Šæ”¾é”å¹¶è¿”å›null]
    
    O -->|å­˜åœ¨| R[æ„å»ºVOå¯¹è±¡å¹¶ç¼“å­˜30åˆ†é’Ÿ]
    R --> S[é‡Šæ”¾é”å¹¶è¿”å›æ•°æ®]
    
    F --> T[ç»“æŸ]
    G --> T
    J --> T
    M --> T
    Q --> T
    S --> T
```
