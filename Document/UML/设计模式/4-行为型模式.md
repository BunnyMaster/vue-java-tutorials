## 责任链模式

### 过滤器模式

> [!TIP]
>
> 这是责任链模式的衍生，实际在GOF 23种设计模式并不存在。

![image-20251212093016505](./assets/image-20251212093016505.png)

#### 接口

```java
public interface ApproverManagementFilter extends Ordered {

    /**
     * 获取执行顺序
     *
     * @return 执行顺序
     */
    String getFilterType();

    /**
     * 审批人导入过滤处理
     *
     * @param cachedDataList 导入Excel过滤结果
     * @return 导入Excel过滤结果
     */
    List<ApproverManagementImportExcelFilterResultBO> process(List<ApproverManagementImportExcelFilterResultBO> cachedDataList);
}
```

#### 接口实现

```java
/**
 * 验证销售组织是否正确
 */
@Component
public class SaleOrgApproverManagementFilter implements ApproverManagementFilter {

    private final CompanyService companyService;

    public SaleOrgApproverManagementFilter(CompanyService companyService) {
        this.companyService = companyService;
    }

    /**
     * 审批人导入过滤处理
     *
     * @param resultBO 审批人Excel模板
     * @return 导入Excel过滤结果
     */
    public ApproverManagementImportExcelFilterResultBO validateData(ApproverManagementImportExcelFilterResultBO resultBO) {
        // 构建错误消息
        StringBuilder errorMessage = new StringBuilder();

        Integer rowIndex = resultBO.getRowIndex();

        // 根据销售组织查询公司信息
        String saleOrg = resultBO.getSaleOrg();
        CompanyListQuery query = new CompanyListQuery();
        query.setSaleCode(saleOrg);
        List<CompanyListVO> companyList = companyService.list(query);

        // 公司信息不存在，跳过
        if (CollectionUtils.isEmpty(companyList)) {
            errorMessage.append("第").append(rowIndex).append("行\t")
                    .append("【销售组织：").append(saleOrg).append("】").append("在系统中不存在\n");
            resultBO.setValid(false);
            resultBO.setMessage(errorMessage.toString());
            return resultBO;
        }

        // 公司信息不完整，跳过
        CompanyListVO companyInfo = companyList.get(0);
        if (StringUtils.isBlank(companyInfo.getArea()) && StringUtils.isBlank(companyInfo.getName())) {
            errorMessage.append("第").append(rowIndex).append("行\t")
                    .append("【销售组织：").append(saleOrg).append("】").append("的公司信息不完整");
            resultBO.setValid(false);
            resultBO.setMessage(errorMessage.toString());
            return resultBO;
        }

        resultBO.setFinanceCode(saleOrg);
        resultBO.setArea(companyInfo.getArea());
        resultBO.setName(companyInfo.getName());
        return resultBO;
    }

    /**
     * 获取执行顺序
     *
     * @return 执行顺序
     */
    @Override
    public int getOrder() {
        return 0;
    }

    /**
     * 获取执行顺序
     *
     * @return 执行顺序
     */
    @Override
    public String getFilterType() {
        return "SaleOrg";
    }

    /**
     * 审批人导入过滤处理
     *
     * @param dataList 导入Excel过滤结果
     * @return 导入Excel过滤结果
     */
    @Override
    public List<ApproverManagementImportExcelFilterResultBO> process(@NotNull List<ApproverManagementImportExcelFilterResultBO> dataList) {
        return dataList.stream().map(this::validateData).collect(Collectors.toList());
    }
}
```

#### 处理管道

在Spring中最佳实践是使用Bean方式读取，如果是手动需要手动添加

```java
@Component
public class ApproverManagementProcessorPipeline {

    private final List<ApproverManagementFilter> filters;

    /**
     * 通过构造器注入所有实现了ApproverManagementFilter的过滤器
     * Spring会自动按Order顺序排序注入
     */
    public ApproverManagementProcessorPipeline(List<ApproverManagementFilter> filters) {
        this.filters = filters.stream()
                .sorted(Comparator.comparingInt(Ordered::getOrder))
                .collect(java.util.stream.Collectors.toList());
    }

    /**
     * 执行所有过滤器
     *
     * @param dataList 导入Excel过滤结果列表
     * @return 过滤后的结果列表
     */
    public List<ApproverManagementImportExcelFilterResultBO> executeFilters(List<ApproverManagementImportExcelFilterResultBO> dataList) {
        if (filters == null || filters.isEmpty()) {
            return dataList;
        }

        List<ApproverManagementImportExcelFilterResultBO> result = dataList;

        // 按顺序执行所有过滤器
        for (ApproverManagementFilter filter : filters) {
            result = filter.process(result);
        }

        return result;
    }
}
```

**手动方式添加**

```java
/**
 * 手动创建并注册所有 Filter 实例
 */
public ApproverManagementFilterContext(CompanyService companyService) {
    this.filters = new ArrayList<>();

    // 手动创建 SaleOrgApproverManagementFilter
    SaleOrgApproverManagementFilter saleOrgFilter = new SaleOrgApproverManagementFilter(companyService);
    filters.add(saleOrgFilter);

    // 可以继续添加其他 Filter...
    // filters.add(new AnotherFilter(...));

    // 按 Order 排序
    filters.sort(Comparator.comparingInt(ApproverManagementFilter::getOrder));
}
```

## 命令模式

## 解释器模式

## 迭代器模式

## 中介者模式

## 备忘录模式

## 观察者模式

## 状态模式

## 策略模式

## 模板方法

### 实现接口方式

先定义接口，之后抽象类进行实现

#### 定义接口

```java
/**
 * 审批人筛选子过滤器
 */
public interface ApproverManagementSubFilter extends Ordered {

    /**
     * 获取执行顺序
     *
     * @return 执行顺序
     */
    String getFilterType();

    /**
     * 处理单个子流程
     *
     * @param systemUerMap 系统用户工号结果
     * @param data         导入Excel过滤结果
     * @return 导入Excel过滤结果
     */
    ApproverManagementImportExcelFilterResultBO process(Map<String, String> systemUerMap, ApproverManagementImportExcelFilterResultBO data);

    /**
     * 获取工号
     * 一定要注意，不要设置错了！！！
     *
     * @param data 导入Excel过滤结果
     * @return 工号
     */
    String getWorkNumber(ApproverManagementImportExcelFilterResultBO data);
}
```

#### 模板方法实现

```java
/**
 * 审批人子过滤器的抽象基类
 */
public abstract class AbstractApproverSubFilter implements ApproverManagementSubFilter {

    /**
     * 获取当前过滤器处理的字段名称（用于错误信息）
     */
    protected abstract String getFieldName();

    /**
     * 获取工号字段值
     *
     * @param data 导入Excel过滤结果
     * @return 工号
     */
    protected abstract String getWorkNumberFromData(ApproverManagementImportExcelFilterResultBO data);

    /**
     * 获取姓名字段值
     *
     * @param data 导入Excel过滤结果
     * @return 姓名
     */
    protected abstract String getNameFromData(ApproverManagementImportExcelFilterResultBO data);

    /**
     * 设置工号字段值
     *
     * @param data       导入Excel过滤结果
     * @param workNumber 工号
     */
    protected abstract void setWorkNumberToData(ApproverManagementImportExcelFilterResultBO data, String workNumber);

    /**
     * 设置姓名字段值
     *
     * @param data 导入Excel过滤结果
     * @param name 姓名
     */
    protected abstract void setNameToData(ApproverManagementImportExcelFilterResultBO data, String name);

    @Override
    public ApproverManagementImportExcelFilterResultBO process(Map<String, String> systemUserMap, ApproverManagementImportExcelFilterResultBO data) {
        StringBuilder errorMessage = new StringBuilder();
        if (data.getMessage() != null) {
            errorMessage.append(data.getMessage());
        }

        // 获取当前字段的工号和姓名
        String workNumber = getWorkNumberFromData(data);
        String name = getNameFromData(data);

        // 如果工号为空，跳过验证
        if (StringUtils.isBlank(workNumber)) {
            return data;
        }

        // 查询系统人员
        String systemUserName = systemUserMap.get(workNumber);

        // 1. 判断系统人员是否存在
        if (StringUtils.isBlank(systemUserName)) {
            setWorkNumberToData(data, workNumber);
            setNameToData(data, null);

            errorMessage.append("\n")
                    .append("第").append(data.getRowIndex()).append("行，")
                    .append(getFieldName()).append("人员工号【")
                    .append(workNumber).append("】不存在，请检查！");
            data.setMessage(errorMessage.toString());
            return data;
        }

        // 2. 判断姓名是否一致
        if (!StringUtils.equals(name, systemUserName)) {
            setNameToData(data, systemUserName);

            errorMessage.append("\n")
                    .append("第").append(data.getRowIndex()).append("行，")
                    .append(getFieldName()).append("人员名称【")
                    .append(name).append("】与工号【")
                    .append(workNumber).append("】不匹配，已自动修正为【")
                    .append(systemUserName).append("】，请检查！");
            data.setMessage(errorMessage.toString());
            return data;
        }

        return data;
    }

    @Override
    public String getWorkNumber(ApproverManagementImportExcelFilterResultBO data) {
        return getWorkNumberFromData(data);
    }
}
```

## 访问者模式