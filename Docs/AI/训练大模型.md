# 训练大模型

## 配置Ubuntu镜像源

### 设置镜像源

#### 备份镜像源

```bash
sudo cp /etc/apt/sources.list /etc/apt/sources.list.back
```

#### 编辑镜像源

```bash
sudo vim /etc/apt/sources.list
```

**镜像源配置**

```shell
deb https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse
deb-src https://mirrors.aliyun.com/ubuntu/ focal main restricted universe multiverse

deb https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse
deb-src https://mirrors.aliyun.com/ubuntu/ focal-security main restricted universe multiverse

deb https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse
deb-src https://mirrors.aliyun.com/ubuntu/ focal-updates main restricted universe multiverse

# deb https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse
# deb-src https://mirrors.aliyun.com/ubuntu/ focal-proposed main restricted universe multiverse

deb https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
deb-src https://mirrors.aliyun.com/ubuntu/ focal-backports main restricted universe multiverse
```

#### 更新软件包列表

```bash
# 首先更新软件包列表
sudo apt update

# 升级已安装的软件包
sudo apt upgrade

# 如果需要完整升级
sudo apt full-upgrade
```

## 搭建`Ollama`

### 安装AI相关

虚拟机安装如果需要GPU将会变得很困难，因为GPU设计的时候没有考虑到共享的可能性，所以无论使用`Hyper-V`还是`VM`都需要一定的操作步骤，但是想体验原生的Linux带来的效果和命令行而且还想用GPU，推荐使用Windows自带的`WSL`。

使用`WSL`直接在微软商店下载即可，但是下载完成默认是在C盘的，很多人因此对此有些担忧，因为占用C盘。

### 安装WSL

安装步骤省略直接跳到如何将WSL安装到其他盘。

```bash
# 查看当前WSL包含的虚拟机
wsl -l -v

# 停止所有的虚拟机
wsl --shutdown

# 导出指定的虚拟机，因为要移动
wsl --export Ubuntu-24.04 E:\WSL\ubuntu.tar

# 导入到新的位置
wsl --import Ubuntu-24.04 E:\WSL\ubuntu E:\WSL\ubuntu.tar --version 2

# 删除之前的虚拟机（注意：命令应为 --unregister）
wsl --unregister Ubuntu-24.04
```

### 安装`Ollama`

官网：https://ollama.com/download/linux

以Linux为例，在`WSL`中输入下面的命令，执行完成后即可。

```sh
curl -fsSL https://ollama.com/install.sh | sh
```

安装完成可以访问：`http://localhost:11434/`显示

```bash
Ollama is running
```

### 常用Ollama命令行

安装完成后，可以使用以下常用命令管理模型：

```bash
# 查看已安装的模型
ollama list

# 拉取模型（不运行）
ollama pull deepseek-coder

# 运行模型
ollama run deepseek-coder

# 删除模型
ollama rm deepseek-coder

# 查看模型信息
ollama show deepseek-coder

# 复制模型（创建新名称）
ollama cp deepseek-coder deepseek-coder-backup

# 启动Ollama服务
ollama serve
```

### 安装DeepSeek

执行的命令和docker十分的相似，只要将docker换成ollama几乎是一样的。

在官网中搜索你想要的模型，比如`DeepSeek`，之后执行下面的命令即可。

```bash
# 拉取并运行DeepSeek模型（推荐先pull再run）
ollama pull deepseek-r1
ollama run deepseek-r1
```

之后会出现交互式命令行，输入问题进行测试即可。

### 注意事项

1. 首次运行模型时会自动下载，需要较长时间，请保持网络稳定
2. 模型文件通常较大，确保有足够的磁盘空间（几个GB到几十GB不等）
3. 如需使用GPU加速，确保系统已安装相应的GPU驱动
4. 可以通过`ollama help`查看所有可用命令

### 验证安装

安装完成后，可以通过以下方式验证：

```bash
# 检查Ollama服务状态
systemctl status ollama

# 或者直接访问API
curl http://localhost:11434/api/tags
```

## 安装Python和pip

> [!TIP]
>
> 需要配置国内镜像：https://www.runoob.com/w3cnote/pip-cn-mirror.html

### 检查Python是否已安装

```bash
python3 --version
```

### 安装脚本

编写脚本并将下面`install_ai.sh`复制

```bash
# 编写脚本
vim install_ai.sh
```

创建一个安装脚本 `install_ai.sh`：

```bash
#!/bin/bash

echo "开始安装AI环境..."

# 更新系统
sudo apt update

# 安装必要的系统包
sudo apt install python3 python3-pip python3-venv -y

# 创建项目目录
mkdir -p ~/my_ai_assistant
cd ~/my_ai_assistant

# 创建虚拟环境（避免系统污染）
python3 -m venv ai_env

# 激活虚拟环境
source ai_env/bin/activate

# 升级pip
pip install --upgrade pip

# 安装AI包（现在在虚拟环境中）
pip install langchain chromadb sentence-transformers ollama pypdf2 python-docx

# 创建项目结构
mkdir -p knowledge_base vector_db scripts

echo "✅ 安装完成！"
echo "📁 项目目录: ~/my_ai_assistant"
echo "🚀 每次使用前运行: cd ~/my_ai_assistant && source ai_env/bin/activate"
echo "🔚 使用后运行: deactivate"
```

给脚本执行权限并运行：

```bash
chmod +x install_ai.sh
./install_ai.sh
```

### 虚拟环境使用

#### 激活虚拟环境

```bash
cd ~/my_ai_assistant
source ai_env/bin/activate
# 命令行前会出现 (ai_env) 提示
```

#### 日常使用流程

```bash
# 1. 激活环境
cd ~/my_ai_assistant && source ai_env/bin/activate

# 2. 运行Python脚本
python your_script.py

# 3. 退出环境
deactivate
```

#### 验证安装

```bash
# 激活虚拟环境后测试
cd ~/my_ai_assistant
source ai_env/bin/activate

# 测试安装
python -c "
try:
    import langchain, chromadb, sentence_transformers, ollama
    print('✅ 所有包安装成功！')
    print('🐍 Python路径:', __import__('sys').executable)
except ImportError as e:
    print('❌ 错误:', e)
"
```

#### **常见问题解决**

**错误：externally-managed-environment**

**原因**：Ubuntu 24.04禁止直接安装Python包到系统
**解决方案**：使用虚拟环境

**错误：Command 'pip' not found**

**解决方案**：

```bash
sudo apt install python3-pip
alias pip='pip3'  # 临时生效
```

**检查虚拟环境是否激活**

```bash
# 正确情况：显示虚拟环境路径
which python
which pip

# 错误情况：显示系统路径
/usr/bin/python
```
